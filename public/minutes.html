<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TÃ¤tigkeiten / Minuten</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #fafafa;
    }
    h2, h3 { color: #333; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background-color: #f4f4f4; }
    form {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
    }
    input, select {
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      border: none;
      background: #4CAF50;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #45a049; }
  </style>
</head>
<body>
  <h2 id="customerNameHeader">TÃ¤tigkeiten / Minuten</h2>

  <p id="customerInfo"></p>

  <form id="minuteForm">
    <input type="hidden" id="customerId">

    <label>TÃ¤tigkeit:
      <input type="text" id="taetigkeit" required>
    </label>

    <label>Minuten:
      <input type="number" id="minuten" required>
    </label>

   <label>Fahrlehrer:
  <select id="fahrlehrer" required></select>
</label>


    <label>Datum:
      <select id="dateType">
        <option value="exact">Exaktes Datum</option>
        <option value="month">Nur Monat</option>
      </select>
      <div id="dateInputs">
        <input type="date" id="datum" lang="de" required>
      </div>
    </label>

    <button type="submit">Eintrag speichern</button>
  </form>

  <h3>Bisherige TÃ¤tigkeiten</h3>
 <table>
  <thead>
    <tr>
      <th>Datum</th>
      <th>TÃ¤tigkeit</th>
      <th>Minuten</th>
      <th>Fahrlehrer</th>
      <th>Aktionen</th> <!-- ğŸ‘ˆ diese Zeile hinzufÃ¼gen -->
    </tr>
  </thead>
  <tbody id="minutesTable"></tbody>
</table>
<div id="total-minutes" style="margin-top:15px;font-weight:600;"></div>


<script>

// --- Kundennamen oben anzeigen ---
document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(window.location.search);
  const customerId = params.get("customer_id");

  if (customerId) {
    try {
      const res = await fetch(`/api/customerbasic/${customerId}`);

      if (!res.ok) throw new Error("Kunde nicht gefunden");
      const customer = await res.json();

      const header = document.getElementById("customerNameHeader");
      if (header) {
        header.textContent = `TÃ¤tigkeiten / Minuten â€“ ${customer.full_name || "Unbekannter Kunde"}`;
      }
      document.title = `TÃ¤tigkeiten â€“ ${customer.full_name || "Kunde"}`;
    } catch (err) {
      console.error("Fehler beim Laden des Kundennamens:", err);
    }
  }
});


// --- Fahrlehrer laden ---
async function loadInstructors() {
  try {
    const res = await fetch("/api/instructors");
    const data = await res.json();
    const select = document.getElementById("fahrlehrer");
    const filtered = data.filter(f => f.name.trim().toLowerCase() !== "k.a.");
    select.innerHTML =
      '<option value="k.A.">k.A.</option>' +
      filtered.map(f => `<option value="${f.name}">${f.name}</option>`).join("");
  } catch (err) {
    console.error("Fehler beim Laden der Fahrlehrer:", err);
  }
}

// --- Kunde-ID aus URL holen ---
const params = new URLSearchParams(window.location.search);
const customerId = params.get("customer_id");
document.getElementById("customerId").value = customerId;

// --- Datumsauswahl ---
document.getElementById("dateType").addEventListener("change", (e) => {
  const container = document.getElementById("dateInputs");
  if (e.target.value === "exact") {
    container.innerHTML = '<input type="date" id="datum" lang="de" required>';
  } else {
    container.innerHTML = '<input type="month" id="datum" lang="de" required>';
  }
});

// --- Minutenliste laden ---
async function loadMinutes() {
  const res = await fetch(`/api/minutes/${customerId}`);
  const data = await res.json();
  const tbody = document.getElementById("minutesTable");
 tbody.innerHTML = data.map(d => `
  <tr data-id="${d.id}">
    <td>${formatGermanDate(d.datum)}</td>
    <td>${d.taetigkeit}</td>
    <td>${d.minuten}</td>
    <td>${d.fahrlehrer}</td>
    <td>
      <button class="edit-minute" data-id="${d.id}">âœï¸</button>
      <button class="delete-minute" data-id="${d.id}">ğŸ—‘ï¸</button>
    </td>
  </tr>
`).join("");

}

// ğŸ”¹ Gesamtminuten + Stunden laden
async function loadTotalMinutes() {
  try {
    const res = await fetch(`/api/minutes/sum/${customerId}`);
    const data = await res.json();

    const sumContainer = document.getElementById("total-minutes");
    if (sumContainer) {
      sumContainer.textContent = `Gesamt: ${data.total_minutes} Min = ${data.total_hours} Std`;
    }
  } catch (err) {
    console.error("Fehler beim Laden der Gesamtminuten:", err);
  }
}

// --- Datumsformat deutsch ---
function formatGermanDate(datum) {
  if (!datum) return "";
  if (/^\d{4}-\d{2}$/.test(datum)) {
    const [y, m] = datum.split("-");
    return `${m}.${y}`;
  }
  if (/^\d{4}-\d{2}-\d{2}$/.test(datum)) {
    const [y, m, d] = datum.split("-");
    return `${d}.${m}.${y}`;
  }
  return datum;
}

// Formular absenden
document.getElementById("minuteForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const taetigkeit = document.getElementById("taetigkeit").value.trim();
  const minuten = document.getElementById("minuten").value.trim();
  const fahrlehrer = document.getElementById("fahrlehrer").value.trim();

  // aktives Datumsfeld holen
  const dateInput = document.querySelector("#dateInputs input");
  let datum = dateInput ? dateInput.value.trim() : "";

  // ğŸ”¹ automatische Formatkorrektur:
  if (datum.includes("/")) {
    // z. B. 10/2023 â†’ 2023-10
    const [m, y] = datum.split("/");
    datum = `${y}-${m}`;
  } else if (datum.includes(".")) {
    // z. B. 10.2023 â†’ 2023-10
    const parts = datum.split(".");
    if (parts.length === 2) datum = `${parts[1]}-${parts[0]}`;
    if (parts.length === 3) datum = `${parts[2]}-${parts[1]}-${parts[0]}`;
  }

  // ğŸ”¹ falls exaktes Datum (YYYY-MM-DD) â†’ nichts Ã¤ndern
  if (/^\d{4}-\d{2}-\d{2}$/.test(datum)) datum = datum;

  console.log("â†’ Gespeichertes Datum:", datum); // Debug

  const res = await fetch("/api/minutes", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ customer_id: customerId, taetigkeit, minuten, fahrlehrer, datum })
  });

  if (res.ok) {
    document.getElementById("minuteForm").reset();
    document.getElementById("dateInputs").innerHTML =
      '<input type="date" id="datum" lang="de" required>';
    loadMinutes();
  } else {
    alert("Fehler beim Speichern!");
  }
});

// Anzeigeformat
function formatGermanDate(datum) {
  if (!datum) return "";
  if (/^\d{4}-\d{2}$/.test(datum)) {
    const [y, m] = datum.split("-");
    return `${m}.${y}`;
  }
  if (/^\d{4}-\d{2}-\d{2}$/.test(datum)) {
    const [y, m, d] = datum.split("-");
    return `${d}.${m}.${y}`;
  }
  return datum;
}


// --- Initial laden ---
loadInstructors();
loadMinutes();
loadTotalMinutes();

// --- Eintrag lÃ¶schen ---
document.addEventListener("click", async (event) => {
  if (event.target.classList.contains("delete-minute")) {
    const id = event.target.dataset.id;
    if (!confirm("Eintrag wirklich lÃ¶schen?")) return;

    await fetch(`/api/minutes/${id}`, { method: "DELETE" });
loadMinutes();
loadTotalMinutes();

  }
});

// --- Eintrag bearbeiten ---
document.addEventListener("click", async (event) => {
  if (event.target.classList.contains("edit-minute")) {
    const row = event.target.closest("tr");
    const id = event.target.dataset.id;

    const cells = row.querySelectorAll("td");
    const [dateCell, taetCell, minCell, fahrCell] = cells;

    dateCell.innerHTML = `<input type="text" value="${dateCell.textContent.trim()}" />`;
    taetCell.innerHTML = `<input type="text" value="${taetCell.textContent.trim()}" />`;
    minCell.innerHTML = `<input type="number" value="${minCell.textContent.trim()}" />`;
    fahrCell.innerHTML = `<input type="text" value="${fahrCell.textContent.trim()}" />`;

    event.target.outerHTML = `<button class="save-minute" data-id="${id}">ğŸ’¾</button>
                              <button class="cancel-minute">âŒ</button>`;
  }

  // --- Ã„nderungen speichern ---
  if (event.target.classList.contains("save-minute")) {
    const id = event.target.dataset.id;
    const row = event.target.closest("tr");
    const inputs = row.querySelectorAll("input");

    let [datum, taetigkeit, minuten, fahrlehrer] = Array.from(inputs).map(i => i.value.trim());

    // Datums-Korrektur beim Speichern (gleiche Logik wie beim Anlegen)
    if (datum.includes("/")) {
      const [m, y] = datum.split("/");
      datum = `${y}-${m}`;
    } else if (datum.includes(".")) {
      const parts = datum.split(".");
      if (parts.length === 2) datum = `${parts[1]}-${parts[0]}`;
      if (parts.length === 3) datum = `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    await fetch(`/api/minutes/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ datum, taetigkeit, minuten, fahrlehrer })
    });

    loadMinutes();
    loadTotalMinutes();

  }

  // --- Bearbeitung abbrechen ---
  if (event.target.classList.contains("cancel-minute")) {
    loadMinutes();
    loadTotalMinutes();

  }
});

</script>

</body>
</html>
