<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tätigkeiten / Minuten</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #fafafa;
    }
    h2, h3 { color: #333; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background-color: #f4f4f4; }
    form {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
    }
    input, select {
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      border: none;
      background: #4CAF50;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #45a049; }
  </style>
</head>
<body>
  <h2>Tätigkeiten / Minuten</h2>
  <p id="customerInfo"></p>

  <form id="minuteForm">
    <input type="hidden" id="customerId">

    <label>Tätigkeit:
      <input type="text" id="taetigkeit" required>
    </label>

    <label>Minuten:
      <input type="number" id="minuten" required>
    </label>

   <label>Fahrlehrer:
  <select id="fahrlehrer" required></select>
</label>


    <label>Datum:
      <select id="dateType">
        <option value="exact">Exaktes Datum</option>
        <option value="month">Nur Monat</option>
      </select>
      <div id="dateInputs">
        <input type="date" id="datum" lang="de" required>
      </div>
    </label>

    <button type="submit">Eintrag speichern</button>
  </form>

  <h3>Bisherige Tätigkeiten</h3>
  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Tätigkeit</th>
        <th>Minuten</th>
        <th>Fahrlehrer</th>
      </tr>
    </thead>
    <tbody id="minutesTable"></tbody>
  </table>

  <script>

// Fahrlehrer-Liste dynamisch laden (wie auf der Hauptseite)
async function loadInstructors() {
  try {
    const res = await fetch("/api/instructors");
    const data = await res.json();
    const select = document.getElementById("fahrlehrer");

    // "k.A." nur einmal anzeigen
    const filtered = data.filter(f => f.name.trim().toLowerCase() !== "k.a.");
    select.innerHTML = '<option value="k.A.">k.A.</option>' +
      filtered.map(f => `<option value="${f.name}">${f.name}</option>`).join("");
  } catch (err) {
    console.error("Fehler beim Laden der Fahrlehrer:", err);
  }
}



    // Customer-ID aus URL holen
    const params = new URLSearchParams(window.location.search);
    const customerId = params.get("customer_id");
    document.getElementById("customerId").value = customerId;

    // Datumsauswahl (Tag oder Monat)
    document.getElementById("dateType").addEventListener("change", (e) => {
      const type = e.target.value;
      const container = document.getElementById("dateInputs");
      if (type === "exact") {
        container.innerHTML = '<input type="date" id="datum" lang="de" required>';
      } else {
        container.innerHTML = '<input type="month" id="datum" lang="de" required>';
      }
    });

    // Minutenliste laden
    async function loadMinutes() {
      const res = await fetch(`/api/minutes/${customerId}`);
      const data = await res.json();
      const tbody = document.getElementById("minutesTable");
      tbody.innerHTML = data.map(d => `
        <tr>
          <td>${formatGermanDate(d.datum)}</td>
          <td>${d.taetigkeit}</td>
          <td>${d.minuten}</td>
          <td>${d.fahrlehrer}</td>
        </tr>
      `).join("");
    }

    // Deutsches Datumsformat
    function formatGermanDate(datum) {
      if (!datum) return "";
      if (datum.length === 7) { // "2025-10"
        const [y, m] = datum.split("-");
        return `${m}.${y}`;
      } else if (datum.length === 10) { // "2025-11-08"
        const [y, m, d] = datum.split("-");
        return `${d}.${m}.${y}`;
      } else return datum;
    }

    // Formular absenden
    document.getElementById("minuteForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const taetigkeit = document.getElementById("taetigkeit").value.trim();
      const minuten = document.getElementById("minuten").value.trim();
      const fahrlehrer = document.getElementById("fahrlehrer").value.trim();
      const datum = document.getElementById("datum").value.trim();

      const res = await fetch("/api/minutes", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ customer_id: customerId, taetigkeit, minuten, fahrlehrer, datum })
      });

      if (res.ok) {
        document.getElementById("minuteForm").reset();
        loadMinutes();
      } else {
        alert("Fehler beim Speichern!");
      }
    });

    loadInstructors();
    loadMinutes();
  </script>
</body>
</html>
